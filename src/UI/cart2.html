<!--<!DOCTYPE html>-->
<!--<html lang="en">-->
<!--<head>-->
<!--    <meta charset="UTF-8">-->
<!--    <meta name="viewport" content="width=device-width, initial-scale=1.0">-->
<!--    <title>Shopping Cart</title>-->
<!--    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">-->
<!--    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">-->
<!--    <link rel="stylesheet" href="assets/css/styles.css">-->
<!--    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>-->
<!--</head>-->
<!--<body>-->
<!--<div class="container mt-5">-->
<!--    <h1 class="mb-4">Your Shopping Cart</h1>-->

<!--    <div class="row">-->
<!--        &lt;!&ndash; Cart Items Section &ndash;&gt;-->
<!--        <div class="col-lg-8">-->
<!--            <div class="card mb-4">-->
<!--                <div class="card-body">-->
<!--                    <div id="cart-items">-->
<!--                        &lt;!&ndash; Cart items will be loaded here &ndash;&gt;-->
<!--                        <div id="empty-cart-message" class="text-center py-5">-->
<!--                            <h4>Your cart is empty</h4>-->
<!--                            <p>Browse our products and add something to your cart!</p>-->
<!--                            <a href="index.html" class="btn btn-primary mt-3">Continue Shopping</a>-->
<!--                        </div>-->
<!--                    </div>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->

<!--        &lt;!&ndash; Order Summary Section &ndash;&gt;-->
<!--        <div class="col-lg-4">-->
<!--            <div class="card">-->
<!--                <div class="card-body">-->
<!--                    <h4 class="card-title">Order Summary</h4>-->
<!--                    <hr>-->
<!--                    <div class="d-flex justify-content-between mb-4">-->
<!--                        <h5>Total</h5>-->
<!--                        <h5 id="total">Rs. 0.00</h5>-->
<!--                    </div>-->
<!--                    <button id="checkout-btn" class="btn btn-primary w-100" style="background-color: #0a7567">-->
<!--                        PROCEED TO CHECKOUT-->
<!--                    </button>-->
<!--                    <a href="index.html" class="btn btn-outline-secondary w-100 mt-3">-->
<!--                        CONTINUE SHOPPING-->
<!--                    </a>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->
<!--</div>-->

<!--<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>-->
<!--<script>-->
<!--    $(document).ready(function() {-->
<!--        // First, remove item with ID 2 if it exists-->
<!--        removeFromCart(2);-->

<!--        loadCartItems();-->

<!--        // Event delegation for quantity changes-->
<!--        $(document).on('change', '.item-quantity', function() {-->
<!--            const itemId = $(this).data('item-id');-->
<!--            const newQuantity = parseInt($(this).val());-->

<!--            if (newQuantity <= 0) {-->
<!--                removeFromCart(itemId);-->
<!--            } else {-->
<!--                updateCartItemQuantity(itemId, newQuantity);-->
<!--            }-->

<!--            // Recalculate total when quantity changes-->
<!--            calculateSelectedTotal();-->
<!--        });-->

<!--        // Event delegation for remove buttons-->
<!--        $(document).on('click', '.remove-item', function() {-->
<!--            const itemId = $(this).data('item-id');-->
<!--            removeFromCart(itemId);-->
<!--        });-->

<!--        // Event delegation for select checkboxes-->
<!--        $(document).on('change', '.item-select', function() {-->
<!--            calculateSelectedTotal();-->
<!--        });-->

<!--        // Checkout button-->
<!--        $('#checkout-btn').click(function() {-->
<!--            const selectedItems = getSelectedItems();-->
<!--            if (selectedItems.length === 0) {-->
<!--                alert('No items selected for checkout!');-->
<!--                return;-->
<!--            }-->

<!--            // Save selected items to localStorage for checkout-->
<!--            localStorage.setItem('selectedItems', JSON.stringify(selectedItems));-->

<!--            // Redirect to checkout page-->
<!--            window.location.href = 'checkout.html';-->
<!--        });-->
<!--    });-->

<!--    // Get selected cart items-->
<!--    function getSelectedItems() {-->
<!--        const selectedItems = [];-->
<!--        $('.item-select:checked').each(function() {-->
<!--            const itemId = $(this).data('item-id');-->
<!--            const cartItems = getCartItems();-->
<!--            const selectedItem = cartItems.find(item => item.itemId === itemId);-->
<!--            if (selectedItem) {-->
<!--                selectedItems.push(selectedItem);-->
<!--            }-->
<!--        });-->
<!--        return selectedItems;-->
<!--    }-->

<!--    // Calculate total for selected items-->
<!--    function calculateSelectedTotal() {-->
<!--        let totalAmount = 0;-->

<!--        $('.item-select:checked').each(function() {-->
<!--            const itemId = $(this).data('item-id');-->
<!--            const price = parseFloat($(this).data('price'));-->
<!--            const quantity = parseInt($(`#quantity-${itemId}`).val());-->

<!--            totalAmount += price * quantity;-->
<!--        });-->

<!--        updateOrderSummary(totalAmount);-->
<!--    }-->

<!--    function loadCartItems() {-->
<!--        const cartItems = getCartItems();-->

<!--        if (cartItems.length === 0) {-->
<!--            $('#empty-cart-message').show();-->
<!--            $('#checkout-btn').prop('disabled', true);-->
<!--            updateOrderSummary(0);-->
<!--            return;-->
<!--        }-->

<!--        $('#empty-cart-message').hide();-->
<!--        $('#checkout-btn').prop('disabled', false);-->

<!--        // Get auth token from localStorage-->
<!--        let authToken = localStorage.getItem("authToken");-->

<!--        // Fetch details for each cart item-->
<!--        let cartItemsHtml = '';-->

<!--        const fetchPromises = cartItems.map(cartItem => {-->
<!--            return $.ajax({-->
<!--                url: `http://localhost:8080/api/v1/item/getById/${cartItem.itemId}`,-->
<!--                method: 'GET',-->
<!--                headers: {"Authorization": `Bearer ${authToken}`}-->
<!--            }).then(response => {-->
<!--                if (response.code === 200 && response.data) {-->
<!--                    const item = response.data;-->
<!--                    const itemTotal = item.price * cartItem.quantity;-->

<!--                    return `-->
<!--                    <div class="cart-item mb-3 pb-3 border-bottom" id="cart-item-${cartItem.itemId}">-->
<!--                        <div class="row align-items-center">-->
<!--                            <div class="col-md-1">-->
<!--                                <div class="form-check">-->
<!--                                    <input class="form-check-input item-select" type="checkbox"-->
<!--                                        data-item-id="${cartItem.itemId}"-->
<!--                                        data-price="${item.price}"-->
<!--                                        id="select-${cartItem.itemId}" checked>-->
<!--                                </div>-->
<!--                            </div>-->
<!--                            <div class="col-md-2">-->
<!--                                <img src="http://localhost:8080/uploads/${item.image}" alt="${item.name}" class="img-fluid rounded">-->
<!--                            </div>-->
<!--                            <div class="col-md-3">-->
<!--                                <h5>${item.name}</h5>-->
<!--                                <div class="text-muted">-->
<!--                                    ${cartItem.color ? `Color: ${cartItem.color}` : ''}-->
<!--                                    ${cartItem.storage ? `<br>Storage: ${cartItem.storage}` : ''}-->
<!--                                </div>-->
<!--                            </div>-->
<!--                            <div class="col-md-2 text-center">-->
<!--                                <span>Rs. ${item.price.toFixed(2)}</span>-->
<!--                            </div>-->
<!--                            <div class="col-md-2">-->
<!--                                <select class="form-select item-quantity" data-item-id="${cartItem.itemId}" id="quantity-${cartItem.itemId}">-->
<!--                                    ${generateQuantityOptions(cartItem.quantity)}-->
<!--                                </select>-->
<!--                            </div>-->
<!--                            <div class="col-md-1 text-end">-->
<!--                                <span class="item-total">Rs. ${itemTotal.toFixed(2)}</span>-->
<!--                            </div>-->
<!--                            <div class="col-md-1 text-end">-->
<!--                                <button class="btn btn-sm btn-outline-danger remove-item" data-item-id="${cartItem.itemId}">-->
<!--                                    <i class="bi bi-trash-fill"></i>-->
<!--                                </button>-->
<!--                            </div>-->
<!--                        </div>-->
<!--                    </div>`;-->
<!--                }-->
<!--                return '';-->
<!--            }).catch(err => {-->
<!--                console.error(`Error fetching item ${cartItem.itemId}:`, err);-->
<!--                return '';-->
<!--            });-->
<!--        });-->

<!--        Promise.all(fetchPromises).then(itemsHtml => {-->
<!--            // Add headers row-->
<!--            cartItemsHtml = `-->
<!--            <div class="cart-header mb-3 pb-2 border-bottom d-none d-md-block">-->
<!--                <div class="row">-->
<!--                    <div class="col-md-1"><strong>Select</strong></div>-->
<!--                    <div class="col-md-2"><strong>Image</strong></div>-->
<!--                    <div class="col-md-3"><strong>Product</strong></div>-->
<!--                    <div class="col-md-2 text-center"><strong>Price</strong></div>-->
<!--                    <div class="col-md-2"><strong>Quantity</strong></div>-->
<!--                    <div class="col-md-1 text-end"><strong>Total</strong></div>-->
<!--                    <div class="col-md-1"></div>-->
<!--                </div>-->
<!--            </div>`;-->

<!--            cartItemsHtml += itemsHtml.join('');-->
<!--            $('#cart-items').html(cartItemsHtml);-->

<!--            // Calculate total for selected items (default all selected)-->
<!--            calculateSelectedTotal();-->
<!--        });-->
<!--    }-->

<!--    function generateQuantityOptions(selectedQuantity) {-->
<!--        let options = '';-->
<!--        for (let i = 1; i <= 10; i++) {-->
<!--            options += `<option value="${i}" ${i === selectedQuantity ? 'selected' : ''}>${i}</option>`;-->
<!--        }-->
<!--        return options;-->
<!--    }-->

<!--    function updateOrderSummary(total) {-->
<!--        // Only show the final total, no shipping or tax-->
<!--        $('#total').text(`Rs. ${total.toFixed(2)}`);-->
<!--    }-->

<!--    function getCartItems() {-->
<!--        const cartItems = localStorage.getItem('cartItems');-->
<!--        return cartItems ? JSON.parse(cartItems) : [];-->
<!--    }-->

<!--    function updateCartItemQuantity(itemId, quantity) {-->
<!--        let cartItems = getCartItems();-->

<!--        const itemIndex = cartItems.findIndex(item => item.itemId === itemId);-->
<!--        if (itemIndex !== -1) {-->
<!--            cartItems[itemIndex].quantity = quantity;-->
<!--            localStorage.setItem('cartItems', JSON.stringify(cartItems));-->

<!--            // Update the UI-->
<!--            const price = $('.item-select[data-item-id="' + itemId + '"]').data('price');-->
<!--            const newTotal = price * quantity;-->
<!--            $(`#cart-item-${itemId} .item-total`).text(`Rs. ${newTotal.toFixed(2)}`);-->

<!--            // Recalculate total-->
<!--            calculateSelectedTotal();-->
<!--        }-->
<!--    }-->

<!--    function removeFromCart(itemId) {-->
<!--        let cartItems = getCartItems();-->

<!--        cartItems = cartItems.filter(item => item.itemId !== itemId);-->
<!--        localStorage.setItem('cartItems', JSON.stringify(cartItems));-->

<!--        // Update the UI-->
<!--        $(`#cart-item-${itemId}`).fadeOut(300, function() {-->
<!--            $(this).remove();-->

<!--            if (cartItems.length === 0) {-->
<!--                $('#empty-cart-message').show();-->
<!--                $('#checkout-btn').prop('disabled', true);-->
<!--                updateOrderSummary(0);-->
<!--            } else {-->
<!--                calculateSelectedTotal();-->
<!--            }-->
<!--        });-->
<!--    }-->

<!--    // Function to add item to cart (for reference)-->
<!--    function addToCart(item) {-->
<!--        let cartItems = getCartItems();-->

<!--        // Check if item already exists in cart-->
<!--        const existingItemIndex = cartItems.findIndex(cartItem =>-->
<!--            cartItem.itemId === item.itemId &&-->
<!--            cartItem.color === item.color &&-->
<!--            cartItem.storage === item.storage-->
<!--        );-->

<!--        if (existingItemIndex !== -1) {-->
<!--            // Update quantity if item already exists-->
<!--            cartItems[existingItemIndex].quantity += item.quantity;-->
<!--        } else {-->
<!--            // Add new item to cart-->
<!--            cartItems.push(item);-->
<!--        }-->

<!--        // Save updated cart to localStorage-->
<!--        localStorage.setItem('cartItems', JSON.stringify(cartItems));-->
<!--    }-->
<!--</script>-->
<!--</body>-->
<!--</html>-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="assets/css/styles.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div class="container mt-5">
    <h1 class="mb-4">Your Shopping Cart</h1>

    <div class="row">
        <!-- Cart Items Section -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-body">
                    <div id="cart-items">
                        <!-- Cart items will be loaded here -->
                        <div id="empty-cart-message" class="text-center py-5">
                            <h4>Your cart is empty</h4>
                            <p>Browse our products and add something to your cart!</p>
                            <a href="index.html" class="btn btn-primary mt-3">Continue Shopping</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Summary Section -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title">Order Summary</h4>
                    <hr>
                    <div class="d-flex justify-content-between mb-4">
                        <h5>Total</h5>
                        <h5 id="total">Rs. 0.00</h5>
                    </div>
                    <button id="checkout-btn" class="btn btn-primary w-100" style="background-color: #0a7567">
                        PROCEED TO CHECKOUT
                    </button>
                    <a href="index.html" class="btn btn-outline-secondary w-100 mt-3">
                        CONTINUE SHOPPING
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="emailVerificationModal" tabindex="-1" aria-labelledby="emailVerificationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="emailVerificationModalLabel">Enter Your Email</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="userEmail" class="form-label">Email address</label>
                    <input type="email" class="form-control" id="userEmail" placeholder="name@example.com" required>
                    <div class="invalid-feedback">
                        Please enter a valid email address.
                    </div>
                </div>
                <div id="emailVerificationMessage" class="mt-2"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="verifyEmailBtn" style="background-color: #0a7567">Continue</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    $(document).ready(function() {
        // Load cart items from localStorage
        loadCartItems();

        // Event delegation for quantity changes
        $(document).on('change', '.item-quantity', function() {
            const itemId = $(this).data('item-id');
            const newQuantity = parseInt($(this).val());

            if (newQuantity <= 0) {
                removeFromCart(itemId);
            } else {
                updateCartItemQuantity(itemId, newQuantity);
            }

            // Recalculate total when quantity changes
            calculateSelectedTotal();
        });

        // Event delegation for remove buttons
        $(document).on('click', '.remove-item', function() {
            const itemId = $(this).data('item-id');
            removeFromCart(itemId);
        });

        // Event delegation for select checkboxes
        $(document).on('change', '.item-select', function() {
            calculateSelectedTotal();
        });

        // Update the checkout button click event
        $('#checkout-btn').off('click').on('click', function() {
            const selectedItems = getSelectedItems();
            console.log("Selected items for checkout:", selectedItems);

            if (selectedItems.length === 0) {
                alert('No items selected for checkout!');
                return;
            }

            // Save selected items to localStorage for checkout
            localStorage.setItem('selectedItems', JSON.stringify(selectedItems));

            // Show the email verification modal
            const emailModal = new bootstrap.Modal(document.getElementById('emailVerificationModal'));
            emailModal.show();
        });

        // Handle email verification
        $('#verifyEmailBtn').on('click', function() {
            const email = $('#userEmail').val().trim();

            // Basic client-side validation
            if (!isValidEmail(email)) {
                $('#userEmail').addClass('is-invalid');
                return;
            }

            $('#userEmail').removeClass('is-invalid');
            $('#emailVerificationMessage').html('<div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div> Verifying email...');

            // Get auth token from localStorage
            let authToken = localStorage.getItem("authToken");

            // Check if email exists in database
            $.ajax({
                url: 'http://localhost:8080/api/v1/user/check-email',
                method: 'POST',
                contentType: 'application/json',
                headers: {"Authorization": `Bearer ${authToken}`},
                data: JSON.stringify({ email: email }),
                success: function(response) {
                    if (response.code === 200) {
                        // Store the email for the checkout process
                        localStorage.setItem('checkoutEmail', email);

                        // Clear message
                        $('#emailVerificationMessage').html('');

                        // Close modal
                        bootstrap.Modal.getInstance(document.getElementById('emailVerificationModal')).hide();

                        // Redirect based on email existence
                        if (response.data === true) {
                            // Email exists, go to payment page
                            window.location.href = 'pay.html';
                        } else {
                            // Email doesn't exist, go to registration page
                            window.location.href = 'register.html';
                        }
                    } else {
                        $('#emailVerificationMessage').html('<div class="alert alert-danger">Error verifying email. Please try again.</div>');
                    }
                },
                error: function(xhr, status, error) {
                    $('#emailVerificationMessage').html('<div class="alert alert-danger">Error connecting to the server. Please try again later.</div>');
                    console.error('Error checking email:', error);
                }
            });
        });

        // Add event listener for Enter key in email input
        $('#userEmail').on('keyup', function(e) {
            if (e.key === 'Enter') {
                $('#verifyEmailBtn').click();
            }
        });
    });

    // Email validation function
    function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    // Get selected cart items - Fixed to handle string IDs correctly
    function getSelectedItems() {
        const selectedItems = [];
        console.log("Checking for selected items...");
        console.log("Number of checked checkboxes:", $('.item-select:checked').length);

        $('.item-select:checked').each(function() {
            const itemId = $(this).data('item-id');
            console.log("Found checked item with ID:", itemId);

            const cartItems = getCartItems();
            console.log("Cart items:", cartItems);

            // Convert both to strings for comparison
            const selectedItem = cartItems.find(item => String(item.itemId) === String(itemId));
            console.log("Matched item:", selectedItem);

            if (selectedItem) {
                selectedItems.push(selectedItem);
            }
        });

        console.log("Final selected items:", selectedItems);
        return selectedItems;
    }

    // Calculate total for selected items
    function calculateSelectedTotal() {
        let totalAmount = 0;

        $('.item-select:checked').each(function() {
            const itemId = $(this).data('item-id');
            const price = parseFloat($(this).data('price'));
            const quantity = parseInt($(`#quantity-${itemId}`).val());

            totalAmount += price * quantity;
        });

        updateOrderSummary(totalAmount);
    }

    function loadCartItems() {
        const cartItems = getCartItems();
        console.log("Loading cart items:", cartItems);

        if (cartItems.length === 0) {
            $('#empty-cart-message').show();
            $('#checkout-btn').prop('disabled', true);
            updateOrderSummary(0);
            return;
        }

        $('#empty-cart-message').hide();
        $('#checkout-btn').prop('disabled', false);

        // Get auth token from localStorage
        let authToken = localStorage.getItem("authToken");

        // Fetch details for each cart item
        let cartItemsHtml = '';

        const fetchPromises = cartItems.map(cartItem => {
            return $.ajax({
                url: `http://localhost:8080/api/v1/item/getById/${cartItem.itemId}`,
                method: 'GET',
                headers: {"Authorization": `Bearer ${authToken}`}
            }).then(response => {
                if (response.code === 200 && response.data) {
                    const item = response.data;
                    const itemTotal = item.price * cartItem.quantity;

                    return `
                <div class="cart-item mb-3 pb-3 border-bottom" id="cart-item-${cartItem.itemId}">
                    <div class="row align-items-center">
                        <div class="col-md-1">
                            <div class="form-check">
                                <input class="form-check-input item-select" type="checkbox"
                                    data-item-id="${cartItem.itemId}"
                                    data-price="${item.price}"
                                    id="select-${cartItem.itemId}" checked>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <img src="http://localhost:8080/uploads/${item.image}" alt="${item.name}" class="img-fluid rounded">
                        </div>
                        <div class="col-md-3">
                            <h5>${item.name}</h5>
                            <div class="text-muted">
                                ${cartItem.color ? `Color: ${cartItem.color}` : ''}
                                ${cartItem.storage ? `<br>Storage: ${cartItem.storage}` : ''}
                            </div>
                        </div>
                        <div class="col-md-2 text-center">
                            <span>Rs. ${item.price.toFixed(2)}</span>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select item-quantity" data-item-id="${cartItem.itemId}" id="quantity-${cartItem.itemId}">
                                ${generateQuantityOptions(cartItem.quantity)}
                            </select>
                        </div>
                        <div class="col-md-1 text-end">
                            <span class="item-total">Rs. ${itemTotal.toFixed(2)}</span>
                        </div>
                        <div class="col-md-1 text-end">
                            <button class="btn btn-sm btn-outline-danger remove-item" data-item-id="${cartItem.itemId}">
                                <i class="bi bi-trash-fill"></i>
                            </button>
                        </div>
                    </div>
                </div>`;
                }
                return '';
            }).catch(err => {
                console.error(`Error fetching item ${cartItem.itemId}:`, err);
                return '';
            });
        });

        Promise.all(fetchPromises).then(itemsHtml => {
            // Add headers row
            cartItemsHtml = `
        <div class="cart-header mb-3 pb-2 border-bottom d-none d-md-block">
            <div class="row">
                <div class="col-md-1"><strong>Select</strong></div>
                <div class="col-md-2"><strong>Image</strong></div>
                <div class="col-md-3"><strong>Product</strong></div>
                <div class="col-md-2 text-center"><strong>Price</strong></div>
                <div class="col-md-2"><strong>Quantity</strong></div>
                <div class="col-md-1 text-end"><strong>Total</strong></div>
                <div class="col-md-1"></div>
            </div>
        </div>`;

            cartItemsHtml += itemsHtml.join('');
            $('#cart-items').html(cartItemsHtml);

            // Force update to ensure checkboxes are checked by default
            $('.item-select').prop('checked', true);

            // Calculate total for selected items (default all selected)
            calculateSelectedTotal();

            // Debug: Count checked items after loading
            console.log("Checked items after loading:", $('.item-select:checked').length);
        });
    }

    function generateQuantityOptions(selectedQuantity) {
        let options = '';
        for (let i = 1; i <= 10; i++) {
            options += `<option value="${i}" ${i === selectedQuantity ? 'selected' : ''}>${i}</option>`;
        }
        return options;
    }

    function updateOrderSummary(total) {
        // Only show the final total, no shipping or tax
        $('#total').text(`Rs. ${total.toFixed(2)}`);
    }

    function getCartItems() {
        const cartItems = localStorage.getItem('cartItems');
        return cartItems ? JSON.parse(cartItems) : [];
    }

    function updateCartItemQuantity(itemId, quantity) {
        let cartItems = getCartItems();

        const itemIndex = cartItems.findIndex(item => String(item.itemId) === String(itemId));
        if (itemIndex !== -1) {
            cartItems[itemIndex].quantity = quantity;
            localStorage.setItem('cartItems', JSON.stringify(cartItems));

            // Update the UI
            const price = $('.item-select[data-item-id="' + itemId + '"]').data('price');
            const newTotal = price * quantity;
            $(`#cart-item-${itemId} .item-total`).text(`Rs. ${newTotal.toFixed(2)}`);

            // Recalculate total
            calculateSelectedTotal();
        }
    }

    function removeFromCart(itemId) {
        let cartItems = getCartItems();

        // Fixed strict equality comparison
        cartItems = cartItems.filter(item => String(item.itemId) !== String(itemId));
        localStorage.setItem('cartItems', JSON.stringify(cartItems));

        // Update the UI
        $(`#cart-item-${itemId}`).fadeOut(300, function() {
            $(this).remove();

            if (cartItems.length === 0) {
                $('#empty-cart-message').show();
                $('#checkout-btn').prop('disabled', true);
                updateOrderSummary(0);
            } else {
                calculateSelectedTotal();
            }
        });
    }

    // Modified function to add item to cart - to be used on product pages
    function addToCart(item) {
        let cartItems = getCartItems();

        // Always add as a new item with its own entry in the cart
        cartItems.push({
            itemId: item.itemId,
            quantity: item.quantity || 1,
            color: item.color || null,
            storage: item.storage || null,
            timestamp: new Date().getTime() // Add timestamp to make each entry unique
        });

        // Save updated cart to localStorage
        localStorage.setItem('cartItems', JSON.stringify(cartItems));

        // Return the updated cart item count
        return cartItems.length;
    }
</script>
<!--<script>-->
<!--    $(document).ready(function() {-->
<!--        // Load cart items from localStorage-->
<!--        // But don't update quantities when adding same products-->
<!--        loadCartItems();-->

<!--        // Event delegation for quantity changes-->
<!--        $(document).on('change', '.item-quantity', function() {-->
<!--            const itemId = $(this).data('item-id');-->
<!--            const newQuantity = parseInt($(this).val());-->

<!--            if (newQuantity <= 0) {-->
<!--                removeFromCart(itemId);-->
<!--            } else {-->
<!--                updateCartItemQuantity(itemId, newQuantity);-->
<!--            }-->

<!--            // Recalculate total when quantity changes-->
<!--            calculateSelectedTotal();-->
<!--        });-->

<!--        // Event delegation for remove buttons-->
<!--        $(document).on('click', '.remove-item', function() {-->
<!--            const itemId = $(this).data('item-id');-->
<!--            removeFromCart(itemId);-->
<!--        });-->

<!--        // Event delegation for select checkboxes-->
<!--        $(document).on('change', '.item-select', function() {-->
<!--            calculateSelectedTotal();-->
<!--        });-->

<!--        // Update the checkout button click event-->
<!--        $('#checkout-btn').off('click').on('click', function() {-->
<!--            const selectedItems = getSelectedItems();-->
<!--            if (selectedItems.length === 0) {-->
<!--                alert('No items selected for checkout!');-->
<!--                return;-->
<!--            }-->

<!--            // Save selected items to localStorage for checkout-->
<!--            localStorage.setItem('selectedItems', JSON.stringify(selectedItems));-->

<!--            // Show the email verification modal-->
<!--            const emailModal = new bootstrap.Modal(document.getElementById('emailVerificationModal'));-->
<!--            emailModal.show();-->
<!--        });-->

<!--        // Handle email verification-->
<!--        $('#verifyEmailBtn').on('click', function() {-->
<!--            const email = $('#userEmail').val().trim();-->

<!--            // Basic client-side validation-->
<!--            if (!isValidEmail(email)) {-->
<!--                $('#userEmail').addClass('is-invalid');-->
<!--                return;-->
<!--            }-->

<!--            $('#userEmail').removeClass('is-invalid');-->
<!--            $('#emailVerificationMessage').html('<div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div> Verifying email...');-->

<!--            // Get auth token from localStorage-->
<!--            let authToken = localStorage.getItem("authToken");-->

<!--            // Check if email exists in database-->
<!--            $.ajax({-->
<!--                url: 'http://localhost:8080/api/v1/user/check-email',-->
<!--                method: 'POST',-->
<!--                contentType: 'application/json',-->
<!--                headers: {"Authorization": `Bearer ${authToken}`},-->
<!--                data: JSON.stringify({ email: email }),-->
<!--                success: function(response) {-->
<!--                    if (response.code === 200) {-->
<!--                        // Store the email for the checkout process-->
<!--                        localStorage.setItem('checkoutEmail', email);-->

<!--                        // Clear message-->
<!--                        $('#emailVerificationMessage').html('');-->

<!--                        // Close modal-->
<!--                        bootstrap.Modal.getInstance(document.getElementById('emailVerificationModal')).hide();-->

<!--                        // Redirect based on email existence-->
<!--                        if (response.data === true) {-->
<!--                            // Email exists, go to payment page-->
<!--                            window.location.href = 'pay.html';-->
<!--                        } else {-->
<!--                            // Email doesn't exist, go to registration page-->
<!--                            window.location.href = 'register.html';-->
<!--                        }-->
<!--                    } else {-->
<!--                        $('#emailVerificationMessage').html('<div class="alert alert-danger">Error verifying email. Please try again.</div>');-->
<!--                    }-->
<!--                },-->
<!--                error: function(xhr, status, error) {-->
<!--                    $('#emailVerificationMessage').html('<div class="alert alert-danger">Error connecting to the server. Please try again later.</div>');-->
<!--                    console.error('Error checking email:', error);-->
<!--                }-->
<!--            });-->
<!--        });-->

<!--        // Add event listener for Enter key in email input-->
<!--        $('#userEmail').on('keyup', function(e) {-->
<!--            if (e.key === 'Enter') {-->
<!--                $('#verifyEmailBtn').click();-->
<!--            }-->
<!--        });-->
<!--    });-->

<!--    // Email validation function-->
<!--    function isValidEmail(email) {-->
<!--        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;-->
<!--        return emailRegex.test(email);-->
<!--    }-->

<!--    // Get selected cart items-->
<!--    function getSelectedItems() {-->
<!--        const selectedItems = [];-->
<!--        $('.item-select:checked').each(function() {-->
<!--            const itemId = $(this).data('item-id');-->
<!--            const cartItems = getCartItems();-->
<!--            const selectedItem = cartItems.find(item => item.itemId === itemId);-->
<!--            if (selectedItem) {-->
<!--                selectedItems.push(selectedItem);-->
<!--            }-->
<!--        });-->
<!--        return selectedItems;-->
<!--    }-->

<!--    // Calculate total for selected items-->
<!--    function calculateSelectedTotal() {-->
<!--        let totalAmount = 0;-->

<!--        $('.item-select:checked').each(function() {-->
<!--            const itemId = $(this).data('item-id');-->
<!--            const price = parseFloat($(this).data('price'));-->
<!--            const quantity = parseInt($(`#quantity-${itemId}`).val());-->

<!--            totalAmount += price * quantity;-->
<!--        });-->

<!--        updateOrderSummary(totalAmount);-->
<!--    }-->

<!--    function loadCartItems() {-->
<!--        const cartItems = getCartItems();-->

<!--        if (cartItems.length === 0) {-->
<!--            $('#empty-cart-message').show();-->
<!--            $('#checkout-btn').prop('disabled', true);-->
<!--            updateOrderSummary(0);-->
<!--            return;-->
<!--        }-->

<!--        $('#empty-cart-message').hide();-->
<!--        $('#checkout-btn').prop('disabled', false);-->

<!--        // Get auth token from localStorage-->
<!--        let authToken = localStorage.getItem("authToken");-->

<!--        // Fetch details for each cart item-->
<!--        let cartItemsHtml = '';-->

<!--        const fetchPromises = cartItems.map(cartItem => {-->
<!--            return $.ajax({-->
<!--                url: `http://localhost:8080/api/v1/item/getById/${cartItem.itemId}`,-->
<!--                method: 'GET',-->
<!--                headers: {"Authorization": `Bearer ${authToken}`}-->
<!--            }).then(response => {-->
<!--                if (response.code === 200 && response.data) {-->
<!--                    const item = response.data;-->
<!--                    const itemTotal = item.price * cartItem.quantity;-->

<!--                    return `-->
<!--                    <div class="cart-item mb-3 pb-3 border-bottom" id="cart-item-${cartItem.itemId}">-->
<!--                        <div class="row align-items-center">-->
<!--                            <div class="col-md-1">-->
<!--                                <div class="form-check">-->
<!--                                    <input class="form-check-input item-select" type="checkbox"-->
<!--                                        data-item-id="${cartItem.itemId}"-->
<!--                                        data-price="${item.price}"-->
<!--                                        id="select-${cartItem.itemId}" checked>-->
<!--                                </div>-->
<!--                            </div>-->
<!--                            <div class="col-md-2">-->
<!--                                <img src="http://localhost:8080/uploads/${item.image}" alt="${item.name}" class="img-fluid rounded">-->
<!--                            </div>-->
<!--                            <div class="col-md-3">-->
<!--                                <h5>${item.name}</h5>-->
<!--                                <div class="text-muted">-->
<!--                                    ${cartItem.color ? `Color: ${cartItem.color}` : ''}-->
<!--                                    ${cartItem.storage ? `<br>Storage: ${cartItem.storage}` : ''}-->
<!--                                </div>-->
<!--                            </div>-->
<!--                            <div class="col-md-2 text-center">-->
<!--                                <span>Rs. ${item.price.toFixed(2)}</span>-->
<!--                            </div>-->
<!--                            <div class="col-md-2">-->
<!--                                <select class="form-select item-quantity" data-item-id="${cartItem.itemId}" id="quantity-${cartItem.itemId}">-->
<!--                                    ${generateQuantityOptions(cartItem.quantity)}-->
<!--                                </select>-->
<!--                            </div>-->
<!--                            <div class="col-md-1 text-end">-->
<!--                                <span class="item-total">Rs. ${itemTotal.toFixed(2)}</span>-->
<!--                            </div>-->
<!--                            <div class="col-md-1 text-end">-->
<!--                                <button class="btn btn-sm btn-outline-danger remove-item" data-item-id="${cartItem.itemId}">-->
<!--                                    <i class="bi bi-trash-fill"></i>-->
<!--                                </button>-->
<!--                            </div>-->
<!--                        </div>-->
<!--                    </div>`;-->
<!--                }-->
<!--                return '';-->
<!--            }).catch(err => {-->
<!--                console.error(`Error fetching item ${cartItem.itemId}:`, err);-->
<!--                return '';-->
<!--            });-->
<!--        });-->

<!--        Promise.all(fetchPromises).then(itemsHtml => {-->
<!--            // Add headers row-->
<!--            cartItemsHtml = `-->
<!--            <div class="cart-header mb-3 pb-2 border-bottom d-none d-md-block">-->
<!--                <div class="row">-->
<!--                    <div class="col-md-1"><strong>Select</strong></div>-->
<!--                    <div class="col-md-2"><strong>Image</strong></div>-->
<!--                    <div class="col-md-3"><strong>Product</strong></div>-->
<!--                    <div class="col-md-2 text-center"><strong>Price</strong></div>-->
<!--                    <div class="col-md-2"><strong>Quantity</strong></div>-->
<!--                    <div class="col-md-1 text-end"><strong>Total</strong></div>-->
<!--                    <div class="col-md-1"></div>-->
<!--                </div>-->
<!--            </div>`;-->

<!--            cartItemsHtml += itemsHtml.join('');-->
<!--            $('#cart-items').html(cartItemsHtml);-->

<!--            // Calculate total for selected items (default all selected)-->
<!--            calculateSelectedTotal();-->
<!--        });-->
<!--    }-->

<!--    function generateQuantityOptions(selectedQuantity) {-->
<!--        let options = '';-->
<!--        for (let i = 1; i <= 10; i++) {-->
<!--            options += `<option value="${i}" ${i === selectedQuantity ? 'selected' : ''}>${i}</option>`;-->
<!--        }-->
<!--        return options;-->
<!--    }-->

<!--    function updateOrderSummary(total) {-->
<!--        // Only show the final total, no shipping or tax-->
<!--        $('#total').text(`Rs. ${total.toFixed(2)}`);-->
<!--    }-->

<!--    function getCartItems() {-->
<!--        const cartItems = localStorage.getItem('cartItems');-->
<!--        return cartItems ? JSON.parse(cartItems) : [];-->
<!--    }-->

<!--    function updateCartItemQuantity(itemId, quantity) {-->
<!--        let cartItems = getCartItems();-->

<!--        const itemIndex = cartItems.findIndex(item => item.itemId === itemId);-->
<!--        if (itemIndex !== -1) {-->
<!--            cartItems[itemIndex].quantity = quantity;-->
<!--            localStorage.setItem('cartItems', JSON.stringify(cartItems));-->

<!--            // Update the UI-->
<!--            const price = $('.item-select[data-item-id="' + itemId + '"]').data('price');-->
<!--            const newTotal = price * quantity;-->
<!--            $(`#cart-item-${itemId} .item-total`).text(`Rs. ${newTotal.toFixed(2)}`);-->

<!--            // Recalculate total-->
<!--            calculateSelectedTotal();-->
<!--        }-->
<!--    }-->

<!--    function removeFromCart(itemId) {-->
<!--        let cartItems = getCartItems();-->

<!--       // cartItems = cartItems.filter(item => item.itemId !== itemId);-->
<!--       // cartItems = cartItems.filter(item => item.itemId != itemId);-->
<!--        cartItems = cartItems.filter(item => item.itemId !== itemId);-->
<!--        localStorage.setItem('cartItems', JSON.stringify(cartItems));-->

<!--        // Update the UI-->
<!--        $(`#cart-item-${itemId}`).fadeOut(300, function() {-->
<!--            $(this).remove();-->

<!--            if (cartItems.length === 0) {-->
<!--                $('#empty-cart-message').show();-->
<!--                $('#checkout-btn').prop('disabled', true);-->
<!--                updateOrderSummary(0);-->
<!--            } else {-->
<!--                calculateSelectedTotal();-->
<!--            }-->
<!--        });-->
<!--    }-->

<!--    // Modified function to add item to cart - to be used on product pages-->
<!--    // This ensures items are always added as new items, never incrementing quantity-->
<!--    function addToCart(item) {-->
<!--        let cartItems = getCartItems();-->

<!--        // Always add as a new item with its own entry in the cart-->
<!--        // instead of incrementing quantity of existing items-->
<!--        cartItems.push({-->
<!--            itemId: item.itemId,-->
<!--            quantity: item.quantity || 1,-->
<!--            color: item.color || null,-->
<!--            storage: item.storage || null,-->
<!--            timestamp: new Date().getTime() // Add timestamp to make each entry unique-->
<!--        });-->

<!--        // Save updated cart to localStorage-->
<!--        localStorage.setItem('cartItems', JSON.stringify(cartItems));-->

<!--        // Return the updated cart item count-->
<!--        return cartItems.length;-->
<!--    }-->


<!--</script>-->
</body>
</html>