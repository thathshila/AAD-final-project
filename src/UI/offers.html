<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offer Form</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-image: url('assets/img/hero-carousel-1.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            margin: 0;
            padding: 0;
            color: #333;
        }

        .content-container {
            margin-top: 80px;
            padding: 20px;
        }

        .form-container {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            text-align: center;
        }

        .form-container h3 {
            margin-bottom: 10px;
            color: #004d40;
        }

        .form-container .row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .form-container input, .form-container select {
            width: 48%;
            padding: 5px;
        }

        .btn-container button {
            width: 100%;
            margin-top: 10px;
            transition: opacity 0.3s ease;
        }

        .btn-container button:hover {
            opacity: 0.8;
        }

        .card-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }

        .offer-card {
            background: rgba(255, 255, 255, 0.9); /* Slightly transparent white background */
            color: #333;
            padding: 20px;
            border-radius: 10px;
            width: calc(33.333% - 20px);
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .offer-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        .offer-card h5 {
            color: #00695c;
        }

        .offer-card p {
            color: #666;
        }

        @media (max-width: 768px) {
            .offer-card {
                width: 100%;
            }
        }
    </style>
</head>
<body>

<!-- Content Container -->
<div class="content-container">
    <div class="form-container">
        <h3>MANAGE OFFERS</h3>
        <form id="offerForm">
            <div class="row">
                <input type="text" id="offerName" class="form-control" placeholder="Offer Name">
                <input type="number" id="discount" class="form-control" placeholder="Discount">
                <input type="date" id="validFrom" class="form-control">
                <input type="date" id="validUntil" class="form-control">
                <select class="form-select" id="packageName">
                    <option selected>Select a package</option>
                </select>
            </div>
            <input type="hidden" id="offerId" class="form-control">
            <div class="btn-container">
                <button type="submit" class="btn btn-success">Save</button>
                <button type="button" class="btn btn-success">Update</button>
                <button type="button" class="btn btn-danger">Delete</button>
                <button type="button" class="btn btn-info" onclick="viewOffers()">View</button>
                <button type="button" class="btn btn-warning" onclick="clearForm()">Clear</button>
            </div>
        </form>
    </div>

    <div class="card-container" id="offerList">
        <!-- Offers will be displayed here dynamically -->
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let authToken = localStorage.getItem("authToken");
    loadAllPackageNames();
    viewOffers();

    function loadAllPackageNames() {
        $.ajax({
            url: "http://localhost:8080/api/v1/packages/getNames",
            method: "GET",
            dataType: "json",
            headers: { "Authorization": `Bearer ${authToken}` },
            success: (resp) => {
                console.log("API Response:", resp); // Debugging

                // Check if `resp.data` is an array
                if (!Array.isArray(resp.data)) {
                    console.error("Error: Response data is not an array", resp);
                    return;
                }

                let nameDropdown = $("#packageName");

                // Loop through `resp.data`
                resp.data.forEach(name => {
                    nameDropdown.append(`<option value="${name}">${name}</option>`);
                });
            },
            error: (err) => {
                console.error("Error loading package names:", err);
            }
        });
    }

    $("#packageName").change(function () {
        let selectedName = $(this).val();
        if (selectedName) {
            $.ajax({
                url: `http://localhost:8080/api/v1/packages/getPackageId/${selectedName}`,
                method: "GET",
                dataType: "json",
                headers: { "Authorization": `Bearer ${authToken}` },
                success: function (resp) {
                    console.log("Selected Name Data Response:", resp); // Debugging output

                    if (resp && resp.data) {
                        $("#packageId").val(resp.data); // Set the credit ID field
                    } else {
                        $("#packageId").val("");  // Clear input if no data found
                    }
                },
                error: function (error) {
                    console.error("Error fetching selected name details:", error);
                }
            });
        } else {
            console.log("No name selected.");
            $("#packageId").val("");
        }
    });

    // Attach Save function to the button
    $(document).on("click", "#saveBtn", saveOffer);

    function saveOffer(event) {
        event.preventDefault(); // Prevent form submission

        let offerName = $("#offerName").val();
        let discountPercentage = $("#discountPercentage").val();
        let validFrom = $("#validFrom").val();
        let validUntil = $("#validUntil").val();
        let packageName = $("#packageName").val();
        let packageId = $("#packageId").val();


        if (!offerName || !discountPercentage || !validFrom || !validUntil || packageName === "Select a package") {
            alert("Please fill in all fields.");
            return;
        }

        let offerData = {
            offerName: offerName,
            discountPercentage: discountPercentage,
            validFrom: validFrom,
            validUntil: validUntil,
            packageId: packageId,
        };

        $.ajax({
            url: "http://localhost:8080/api/v1/offers/save",
            method: "POST",
            contentType: "application/json",
            headers: { "Authorization": `Bearer ${authToken}` },
            data: JSON.stringify(offerData),
            success: (response) => {
                alert("Offer saved successfully!");
                console.log("Offer saved:", response);
                // Optionally, clear the form
                $("#offerName").val("");
                $("#discountPercentage").val("");
                $("#validFrom").val("");
                $("#validUntil").val("");
                $("#packageName").val("Select a package");
            },
            error: (err) => {
                console.error("Error saving offer:", err);
                alert("Failed to save offer. Please try again.");
            }
        });
    }

    function viewOffers() {
        $.ajax({
            url: "http://localhost:8080/api/v1/offers/getAll",
            type: "GET",
            headers: { "Authorization": `Bearer ${authToken}` },
            success: function (response) {
                // Empty the existing package list
                $("#offerList   ").empty();

                // Check if the response is in the expected format (array of packages)
                if (!Array.isArray(response.data)) {
                    console.error("Unexpected response format:", response);
                    alert("Error fetching packages. Check console for details.");
                    return;
                }

                // Iterate over the packages and append them to the list
                response.data.forEach(offer => {
                    $("#offerList").append(`
                    <div class="offer-card" onclick="fillForm('${offer.offerName}', '${offer.discountPercentage}','' +
                     '${offer.validFrom}','${offer.validUntil}')">

                        <h5>${offer.offerName}</h5>
                        <p>Discount: ${offer.discountPercentage} %</p>
                        <p>Valid From: ${offer.validFrom}</p>
                        <p>Valid Until: ${offer.validUntil}</p>
                    </div>
                `);
                });
            },
            error: function (xhr) {
                console.error("Failed to load packages:", xhr.responseText);
                alert("Failed to fetch packages.");
            },
        });
    }
</script>
</body>
</html>
